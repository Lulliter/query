---
title: "Bandi - da SIME"
author: Fondazione Cariparma - Osservatorio dei dati sociali
date: last-modified
date-format: "DD-MMMM-YYYY"
lang: it

format:
  html:
    theme: flatly
    code-fold: true
    toc-depth: 3
    toc_float: true
    toc-location: left
    toc-title: Indice
    embed-resources: true
  docx:
    toc: false
    toc-depth: 3
    toc-title: "Indice"
    highlight-style: tango
    embed-resources: true
    page-width: 9
    fig-width: 8
    fig-height: 6
    dpi: 300

execute:
  eval: true
  echo: false
  warning: false
  error: false
  output: false

bibliography: ../assets/CRP_query.bib
suppress-bibliography: false
---

## Bandi

Content for the Bandi page goes here.

```{r}
#| echo: false
#| warning: false

# Your R code here to analyze data from OIS/data_in/
```



```{r}
# Packgs and functions ----
library(here)
library(fs)
library(readxl)
library(janitor)
library(skimr)
library(glue)

library(dplyr)
library(lubridate)
library(tidyr)
library(forcats)
library(stringr)
library(purrr)
library(flextable)
library(sf)
library(ggplot2)
library(ggiraph)
library(camcorder)
library(patchwork) # for combining ggplots
# p1 + p2                    # Affiancati
# p1 / p2                    # Uno sopra l'altro
# p1 | p2                    # Affiancati (equivalente a +)
# (p1 + p2) / p3             # Layout complesso
# p1 + p2 + plot_layout(ncol = 2)  # Specificare colonne

# Colors ----
grey_extra_sc <- "#4F4F4F"
grey_sc <- "#808080"
grey_md1 <- "#A9A9A9"
grey_md2 <- "#D3D3D3"
grey_extrlight <- "#FDFBF7"
burg_sc <- "#5C2129"
burg_md <- "#873C4A"
burg_lg <- "#B85E6A"
blu_sc <- "#033c55"
blu_md <- "#005d82"
blu_lg <- "#5582a7"
grn_sc <- "#246864"
grn_md <- "#539d90"
grn_lg <- "#8eb9b1"
ylw_sc <- "#b27d2c"
ylw_md <- "#d9a44a"
ylw_lg <- "#f0c166"

maschi <- "#6B8FAD"
femmine <- "#C47A87"

grave <- "#834ba0"
moderata <- "#ce78b3"

```


```{r}
# ------- R utilities and functions
source(file = here("R", "f_recap_values.R")) # # f_recap_values(df, c("col1","col2"))
#source(file = here("R","f_ggplot2.R")) # custom ggplot2 theme
source(file = here("R", "f_ft_formatting.R")) # %>% f_ft_properties()
```

# Importazione dati Erogazioni 2024/2025
 
Ho esportato da SIME facendo:
 + `Erogazioni -> Esportazioni su Excel -> Analisi Richieste ed Enti -> Esportazione Totale da Testata` 
 + unico filtro usato `2024` e `2025` 

```{bash}
#| eval: false

SRC='/Users/luisamimmi/Library/CloudStorage/OneDrive-FondazioneCassadiRisparmiodiParmaeMontediCreditosuPegnodiBusseto/Transfer PC2Mac/download_sime'

# da fare uno a uno xch√® i file nella cartella sono "on demand" e non local quindi * non li vede!!!
cp "$SRC/SIME.png" './data_in/' # show query
cp "$SRC/all_2024.xls" './data_in/'
cp "$SRC/all_2025.xls" './data_in/'
```

```{r}
#| label: from_WIN_SIME
#| eval: false

# solo in ufficio!!!! 

# # /Users/luisamimmi/Documents/2025_Cariparma/query_FROM_SIME
# dir_path <- fs::path_expand("~/Documents/2025_Cariparma/query_FROM_SIME")
# 
# 
# # --- 1) COPY content in path TO current project FOLDER SIME/data_in/*  
# fs::dir_copy(dir_path, here("SIME", "data_in"), overwrite = TRUE)
```

```{r}
#--- 2) Ingest xls file sheet 1 (read all as text first)
all_2024_2026_raw <- read_xls(here("SIME", "data_in", "mimmi_bnxlstot.xls"),
                              sheet = 1,
                              col_types = "text")

# Check: which Data values can't be parsed as numeric OR as dmy?
data_issues <- all_2024_2026_raw |>
  select(starts_with("Data")) |>
  pivot_longer(everything(), names_to = "col", values_to = "val") |>
  filter(!is.na(val), val != "") |>
  mutate(
    is_numeric = !is.na(suppressWarnings(as.numeric(val))),
    is_dmy = !is.na(dmy(val, quiet = TRUE))
  ) |>
  filter(!is_numeric, !is_dmy) |>
  count(col, val)

data_issues  # shows problematic values

# Conversion
all_2024_2026 <- all_2024_2026_raw |>
  # Data Costituzione: mixed formats (Excel serial numbers + text "dd/mm/yyyy" for pre-1900)
  # Try numeric first, fallback to text parsing, coalesce picks whichever worked
  mutate(`Data Costituzione` = {
    num <- suppressWarnings(as.numeric(`Data Costituzione`))
    date_from_num <- as.Date(num, origin = "1899-12-30")
    date_from_text <- dmy(`Data Costituzione`, quiet = TRUE)
    coalesce(date_from_num, date_from_text)
  }) |>
  # Other Data columns: Excel serial numbers (days since 1899-12-30)
  mutate(across(starts_with("Data") & !matches("Costituzione"),
                \(x) as.Date(suppressWarnings(as.numeric(x)), origin = "1899-12-30"))) |>
  # Importo/Totale columns: numeric (euro amounts)
  mutate(across(matches("Totale|Importo"), as.numeric)) |>
  relocate('Descrizione Aggettivo', .after = 'Aggettivo') |> 
  relocate(c('Anno', 'Anno Pratica', 'Numero Pratica', 'Titolo progetto', 'Categoria Fondo', 'Fondo', 'Descrizione Fondo'), 
           .before= everything())

names(all_2024_2026)
# Check data types for all cols
types_all_2024_2026 <- all_2024_2026 %>%
  map_chr(~ class(.x)[1]) %>%
  set_names(names(all_2024_2026))
```
 
## Check variabili della tabella `all_2024_2026`
```{r}
# check variables completely empty in BOTH datasets
check_empty <- tibble(
  var_name = names(all_2024_2026),
  is_empty = map_lgl(all_2024_2026, ~ all(is.na(.x))))  |> 
  filter(is_empty == "TRUE") |> 
  filter ( !str_detect (var_name,"Mkt")) # escludo xch√® so gi√† che √® vuota ma potrebbe essere utile in futuro

check_unique_id <- tibble(
  var_name = names(all_2024_2026),
  unique_id = map_lgl(all_2024_2026, ~ n_distinct(.x) == nrow(all_2024_2026))) |> 
  filter(unique_id == TRUE)  

```

### LOOKUP TBLS
```{r}
# lookup tables (named vectors)
lookup_unique_id <- c(
  # "var_name" = "yes" or "no"
)

lookup_desc <- c(
  # "var_name" = "my description"
  "Aggettivo" = "?"
)

lookup_useful <- c(
  # KEY ID
  "Anno" = "yes",
  "Anno Pratica" = "yes",
  "Numero Pratica" = "yes",
  "Titolo progetto" = "yes", # minus
  "Codice Ente" = "yes",
  "Denominazione Sociale" = "yes",


  "Cognome - Nome" = "yes",
  # PROGETTO
  "Stato" = "yes",
  "Descrizione Stato" = "yes",
  "Inammis" = "yes",
  
  "Categoria Fondo" = "yes",
  "Fondo" = "yes",
  "Descrizione Fondo" = "yes",
  
  "Tipo Progetto" = "yes",
  "Categoria Progetto" = "yes",
  "Codice Sottoprogetto" = "yes",
  "Descrizione Sottoprogetto"   = "yes",
  

  "Analisi del contesto" = "yes",
  "Strategia di intervento" = "yes",

  "Sintesi Oggetto" = "yes",
  "Descrizione Sintesi Oggetto" = "yes",
  # "Data Protocollo" = "yes",      
  "Data Documento"  = "yes",
  "Data Delibera"   = "yes", 
  "Data Chiusura"   = "yes",          
  "Data Scadenza"   = "yes",
  # "Data Manifestaz." = "yes"  ,             
  
  "Totale Deliberato" = "yes",
  "Totale Erogato" = "yes",
  "Totale Residuo" = "yes",

  # ENTE
  "L.R. Cognome" = "yes",
  "L.R. Nome" = "yes",
  "L.R. Email" = "yes",

  "Inc.Ric Cognome" = "yes",
  "Inc.Ric Nome" = "yes",
  "Inc.Ric Email" = "yes",

  # "var_name" = "yes" or "no" or "maybe"
  # "Denominazione Sociale" = "yes",
  "Sito Web richiedente" = "yes",
  "Data Creazione" = "yes",
  "Indirizzo" = "yes",
  "Localit√†" = "yes",
  "Quartiere" = "yes",
  "Pv" = "yes",
  "Cap" = "yes",
  "Nazione" = "yes",
  "Area" = "yes",
  "Descrizione Area" = "yes",
  "Zona" = "yes",
  "Descrizione Zona" = "yes",

  "Ambito" = "yes",
  "Descrizione Ambito" = "yes",
  "Settore" = "yes",
  "Descrizione Settore" = "yes",
  "Categoria settore" = "yes", # minusc
  "Categoria" = "yes",
  "Descrizione Categoria" = "yes",

  "Natura Giuridica" = "yes",
  "Descrizione Natura Giuridica" = "yes",
  "Forma Giuridica" = "yes",
  "Descrizione Forma Giuridica" = "yes",
  "Scopo Ente" = "yes",
  "Dati sull'Attivit√†" = "yes",
  "Organi" = "yes"
)


lookup_domain_tbl <- c(
  # "var_name" =  "needed", etc
  "Stato" = "needed",
  "Descrizione Stato" = "needed",
  "Categoria Fondo" = "needed",
  "Fondo" = "needed",
  "Descrizione Fondo" = "needed",

  "Aggregazione territoriale" = "needed",
  "Ambito" = "needed",
  "Descrizione Ambito" = "needed",

  "Categoria" = "needed",
  "Descrizione Categoria" = "needed",
  "Settore" = "needed",
  "Descrizione Settore" = "needed",
  "Categoria Settore" = "needed",

  "Inammis" = "needed",

  "Zona" = "needed",
  "Descrizione Zona" = "needed",
  "Natura Giuridica" = "needed",
  "Descrizione Natura Giuridica" = "needed",
  "Forma Giuridica" = "needed",
  "Descrizione Forma Giuridica" = "needed",

  "Categoria Progetto" = "needed",
  "Codice Sottoprogetto" = "needed",
  "Tipo Progetto" = "needed",
  "Area" = "needed",
  "Descrizione Area" = "needed",
  "Sintesi Oggetto" = "needed",
  "Descrizione Sintesi Oggetto" = "needed"
  
)

length(lookup_domain_tbl)

```

```{r}
# ----- (prep)
# get first non-NA value for each column
examples <- all_2024_2026 |>
  map_chr(
    ~ {
      non_na <- na.omit(.x)
      if (length(non_na) > 0) as.character(non_na[1]) else NA_character_
    }
  )

# check if column is completely empty (all NA) in BOTH datasets
is_empty <- names(all_2024_2026) |>
  map_chr(
    ~ if_else(
      all(is.na(all_2024_2026[[.x]])),
      "yes",
      "no"
    )
  ) |>
  set_names(names(all_2024_2026))

# ----- make a table with the columnns 1) var name, 2) var meaning, 3) unique ID (yes no) 4) dominon available (yes no) .... to be completed later
var_desc_tbl <- all_2024_2026 %>%
  names() %>%
  tibble(var_name = .) |>
  mutate(
    example = examples[var_name],
    all_empty = is_empty[var_name],
    unique_id = NA_character_,
    var_desc = NA_character_,
    useful = NA_character_,
    domain_tbl = NA_character_
  )

# ---- apply lookups + pattern matching with case_when
var_desc_tbl <- var_desc_tbl |>
  mutate(
    var_desc = case_when(
      str_detect(var_name, "Azione Mkt|Referee") ~ "?",
      !is.na(lookup_desc[var_name]) ~ lookup_desc[var_name],
      TRUE ~ var_desc
    ),
    useful = coalesce(lookup_useful[var_name], useful),
    unique_id = coalesce(lookup_unique_id[var_name], unique_id),
    domain_tbl = coalesce(lookup_domain_tbl[var_name], domain_tbl))
```

## [Tbl] Variabili 

```{r}
#| label: var_desc_tbl_ft
#| output: false

var_desc_tbl_ft <- var_desc_tbl %>%
  flextable() %>%
  # Segnalo se utili / approfondimenti necessari
  bg(i = ~ useful == "yes", bg = grn_lg, part = "body") |>
  # Segnalo se vuote
  bg(i = ~ all_empty == "yes",
    j = c("var_name", "all_empty"),
    bg = burg_lg,
    part = "body") |>
  # Segnalo se serve tabella di dominio
  bg(i = ~ domain_tbl == "needed",
    j = c("var_name", "domain_tbl"),
    bg = blu_lg,
    part = "body")

var_desc_tbl_ft

# Save as docx table
save_as_docx(var_desc_tbl_ft,
  path = here("SIME", "data_out", "var_desc_tbl.docx"))
```

## [Tbl] Variabili UTILI da esaminare 

```{r}
#| label: var_desc_tbl2_ft
#| output: true

var_desc_tbl2 <- var_desc_tbl %>%
  select(-unique_id, -var_desc) |>
  filter(useful == "yes") %>%
  mutate(example = str_trunc(example, width = 150)) %>%
  # mutate(var_name = factor(var_name, levels = names(lookup_useful)[lookup_useful == "yes"])) %>%
  mutate(var_name = factor(var_name, levels = names(lookup_useful))) %>%
  arrange(var_name)

var_desc_tbl2_ft <- var_desc_tbl2 |>
  flextable() %>%
  # # Segnalo se utili / approfondimenti necessari
  # bg(i = ~ useful == "yes", bg = grn_lg, part = "body") |>
  # Segnalo se vuote
  bg(
    i = ~ all_empty == "yes",
    j = c("var_name", "all_empty"),
    bg = burg_lg,
    part = "body"
  ) |>
  # Segnalo se serve tabella di dominio
  bg(
    i = ~ domain_tbl == "needed",
    j = c("var_name", "domain_tbl"),
    bg = blu_lg,
    part = "body"
  )

var_desc_tbl2_ft

# Save as docx table
save_as_docx(
  var_desc_tbl2_ft,
  path = here("SIME", "data_out", "var_desc_tbl2.docx")
)
```

# ____ 

# Analisi variabili di PROGETTO

```{r}
var_utili <-  var_desc_tbl2$var_name[var_desc_tbl2$useful == "yes"]

richieste_24_26 <- all_2024_2026 |> 
  select(all_of(var_utili)) |>
  mutate(across(where(is.character), str_squish)) |>  # remove extra spaces
  janitor::clean_names() 
```

## Tabelle di dominio

```{r}
#| label: rec_domain_tbls

# Get all vars that need domain table
domain_vars_all <- names(lookup_domain_tbl)[lookup_domain_tbl == "needed"]
domain_vars_exist <- domain_vars_all[domain_vars_all %in% names(all_2024_2026)]
# order them according to var_desc_tbl2 (which is ordered according to lookup_useful)
domain_vars_ordered <- intersect(var_desc_tbl2$var_name, domain_vars_exist)

rec_domain_tbls <- f_recap_values(all_2024_2026, domain_vars_ordered) |>
  mutate(skim_variable = factor(skim_variable, levels = domain_vars_ordered)) |>
  arrange(skim_variable)

rec_domain_tbls
```

### Forma giuridica
```{r}
table(richieste_24_26$forma_giuridica, useNA = "ifany") |> 
  as.data.frame() |>
  filter(Freq > 0) |> 
  arrange(desc(Freq))

table(richieste_24_26$descrizione_forma_giuridica, useNA = "ifany") |> 
  as.data.frame() |>
  filter(Freq > 0) |> 
  arrange(desc(Freq))

table(richieste_24_26$natura_giuridica, useNA = "ifany") |> 
  as.data.frame() |>
  filter(Freq > 0) |> 
  arrange(desc(Freq))

table(richieste_24_26$descrizione_natura_giuridica, useNA = "ifany") |> 
  as.data.frame() |>
  filter(Freq > 0) |> 
  arrange(desc(Freq))
```

### Descrizione

```{r}
table(richieste_24_26$, useNA = "ifany") |> 
  as.data.frame() |>
  filter(Freq > 0) |> 
  arrange(desc(Freq))
```


## Var sempre vuote o quasi vuote

```{r}
#| label: rec_domain_tbls_ft
#| output: true

rec_domain_tbls_ft <- rec_domain_tbls %>%
    flextable() %>%
    bg(i = ~ as.numeric(gsub("%", "", missing_perc)) > 15, bg = burg_lg, part = "body") 

rec_domain_tbls_ft

# Save as docx table
save_as_docx(rec_domain_tbls_ft,
  path = here("SIME", "data_out", "rec_domain_tbls_ft.docx")
)

```

```{r}
tabyl(richieste_24_26$categoria)
tabyl(richieste_24_26$descrizione_categoria)
table(richieste_24_26$categoria, richieste_24_26$descrizione_categoria, useNA = "ifany") |> 
  as.data.frame() |>
  filter(Freq > 0) |> 
  arrange(desc(Freq))
```

## üü©üü®üüßüü¶ Ricostruzione codice SIME

```{r}

```

# ____ 

## Domande per Area Erogativa

1. Ho esportato da SIME facendo:
`Erogazioni -> Esportazioni su Excel -> Analisi Richieste ed Enti -> Esportazione Totale da Testata` (tutto 2024-2026)

 Qui ho alcune domande:

+ Variabili categoriche (che sembrerebbero utili) ma sono sempre vuote:
  + `Aggregazione territoriale`, `Ambito` e `Descrizione Ambito`, `Codice Sottoprogetto`, `Categoria Progetto`, `Tipo Progetto` sono sempre vuote? 
    + ( `Ambito` ~nel senso del PS o altro?)
  + altre tipo `Indirizzo fiscale`..., `Referee...`, `Manifestazione` 

+ Variabili categoriche (che sembrerebbero utili) ma sono *QUASI* sempre vuote:
  + `Natura Giuridica` e `Descrizione Natura Giuridica` sono quasi sempre vuote (99.7%)... √® un errore rispetto `Forma Giuridica`?
  + `Sintesi Oggetto` e `Descrizione Sintesi Oggetto` sono quasi sempre vuote (99.5%)...  

+ Strano che `Categoria` √® vuoto nel 20.7%, mentre `Descrizione Categoria` √® vuoto solo nello 0.1%... ma le 2 variabili si parlano? (si, ci sono 363 sotto "Inesistente" x cui la Categoria √® NA)

+ `Area` a cosa √® riferito: ENTE; PROGETTO, BANCA? 
+ `Zona` a cosa √® riferito: ENTE; PROGETTO, BANCA? 
